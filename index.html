<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
	<script src="jquery-3.3.1.min.js"></script>
	
    <title>Bomberman</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

</head>
<body style="background-color: black;">

    <canvas id="cvs" width="680" height="520"></canvas>

    <script>

        var c = document.getElementById('cvs');
        var ctx = c.getContext('2d');
        var timer = new Timer();
        timer.interval = 20;
        timer.isLoop = true;
        var blockSize = 40;
        var playerSize = 20;
        var explosionTime = 2500;
        var onFireTime = 1500;
        var immuneAfterDamageTime = 3000;
        var initialBombRange = 2;
        var initialAmountOfBombs = 20;
        var initialPlayerSpeed = 2;
        var initialPlayerHealth = 3;
        var blockType = {
            type_empty: 0,
            type_wall: 1,
            type_crate: 2
        };
        var bombType = {
            type_basic: 0
        };
        var mapWidth = document.getElementById('cvs').width / blockSize;
        var mapHeight = document.getElementById('cvs').height / blockSize;
        var map = [];
        //var Direction = {
        //    UP: 0,
        //    RIGHT: 1,
        //    DOWN: 2,
        //    LEFT: 3
        //};
        var spawnPoints = [
            {
                x: 1,
                y: 1
            },
            {
                x: 15,
                y: 1
            },
            {
                x: 1,
                y: 11
            },
            {
                x: 15,
                y: 11
            }
        ];
        var reservedBlocks = [];
        var reservedBlocksInEachDirectionFromSpawnPoints = 2;
        var cratesPercentage = 0.7;
        var players = [
            new Player(spawnPoints[0].x, spawnPoints[0].y, 1, 'blue'),
            new Player(spawnPoints[1].x, spawnPoints[1].y, 2, 'yellow')
        ];

        function makeMap() {

            for (var i = 0, x = 0, y = 0; i < mapWidth * mapHeight; i++) {

                if (x === mapWidth) {
                    x = 0;
                    y++;
                }
                if (x === 0 || y === 0 || x === mapWidth - 1 || y === mapHeight - 1 || x % 2 === 0 && y % 2 === 0) {
                    map.push({
                        mapPos: {
                            x: x,
                            y: y
                        },
                        canvasPos: {
                            x: Math.floor(x * blockSize),
                            y: Math.floor(y * blockSize)
                        },
                        size: {
                            width: blockSize,
                            height: blockSize
                        },
                        blockType: {
                            blockType: blockType.type_wall
                        },
                        walkThrough: false
                    });
                }
                else {
                    map.push({
                        mapPos: {
                            x: x,
                            y: y
                        },
                        canvasPos: {
                            x: Math.floor(x * blockSize),
                            y: Math.floor(y * blockSize)
                        },
                        size: {
                            width: blockSize,
                            height: blockSize
                        },
                        blockType: {
                            blockType: blockType.type_empty
                        },
                        walkThrough: true,
                        hasBomb: false,
                        bomb: null,
                        onFire: false,
                        letFireDieTimer: new Timer(),
                        catchOnFire: function (x, y, player) {

                            var thisBlock = findBlock(x, y);

                            if (thisBlock.onFire) {
                                clearTimeout(thisBlock.letFireDieTimer.timeout);
                                thisBlock.letFireDieTimer.start();
                            } else {
                                thisBlock.letFireDieTimer.interval = onFireTime;
                                thisBlock.letFireDieTimer.tick = function () {
                                    thisBlock.onFire = false;
                                }
                                thisBlock.onFire = true;
                                thisBlock.letFireDieTimer.start();
                            }

                        }
                        
                    });
                }
                x++;
            }

        }

        function addReservedBlocks() {

            //Loop through spawnpoints
            for (var i = 0; i < spawnPoints.length; i++) {

                //Add spawnpoints to reservedBlocks[]
                reservedBlocks.push({
                    x: spawnPoints[i].x,
                    y: spawnPoints[i].y
                });

                var surroundings = returnSurroundings(spawnPoints[i].x, spawnPoints[i].y, reservedBlocksInEachDirectionFromSpawnPoints);

                for (var j = 0; j < surroundings.directions.length; j++) {

                    for (var k = 0; k < reservedBlocksInEachDirectionFromSpawnPoints; k++) {

                        if (surroundings.directions[j][k] != null) {

                            reservedBlocks.push({
                                x: surroundings.directions[j][k].mapPos.x,
                                y: surroundings.directions[j][k].mapPos.y
                            });

                        }
                        
                    }

                }

            }

        }

        function findBlock(posX, posY) {

            for (var i = 0; i < map.length; i++) {

                if(posX === map[i].mapPos.x && posY === map[i].mapPos.y) {

                    return map[i];
                    break;

                }

            }

        }

        function returnSurroundings(posX, posY, range) {

            var surroundings = {

                range: range,
                center: findBlock(posX, posY),
                directions: [
                    [],
                    [],
                    [],
                    []
                ]

            };

            for (var i = 0, d = 0, r = 1; i < 4 * range; i++) {

                if(i != 0 && i % range === 0) {
                    d++;
                }
                if (r === range + 1) {
                    r = 1;
                }
                switch(d) {
                    case 0: {
                        surroundings.directions[d].push(findBlock(surroundings.center.mapPos.x, surroundings.center.mapPos.y - r));
                    } break;
                    case 1: {
                        surroundings.directions[d].push(findBlock(surroundings.center.mapPos.x + r, surroundings.center.mapPos.y));
                    } break;
                    case 2: {
                        surroundings.directions[d].push(findBlock(surroundings.center.mapPos.x, surroundings.center.mapPos.y + r));
                    } break;
                    case 3: {
                        surroundings.directions[d].push(findBlock(surroundings.center.mapPos.x - r, surroundings.center.mapPos.y));
                    } break;
                }
                r++;

            };

            return surroundings;

        }

        function generateCrates() {

            for (var i = 0; i < map.length; i++) {

                if (map[i].blockType.blockType === blockType.type_empty) {

                    var isReserved = false;
                    for (var j = 0; j < reservedBlocks.length; j++) {

                        if (map[i].mapPos.x === reservedBlocks[j].x && map[i].mapPos.y === reservedBlocks[j].y) {

                            isReserved = true;
                            break;

                        }

                    }

                    if (!isReserved) {

                        if (Math.random() < cratesPercentage) {

                            map[i].blockType.blockType = blockType.type_crate;

                        }

                    }

                }

            }

        }

        function drawMap() {

            for (var i = 0; i < map.length; i++) {
                if (map[i].blockType.blockType === blockType.type_wall) {
                    ctx.fillStyle = "black";
                }
                else if (map[i].blockType.blockType === blockType.type_empty) {
                    if (map[i].onFire === true) {
                        ctx.fillStyle = "orange";
                    } else if (map[i].hasBomb) {
                        ctx.fillStyle = "red";
                    } else {
                        ctx.fillStyle = "green";
                    }
                }
                else if (map[i].blockType.blockType === blockType.type_crate) {
                    ctx.fillStyle = "brown";
                }
                ctx.fillRect(map[i].mapPos.x * blockSize, map[i].mapPos.y * blockSize, blockSize, blockSize);
            }

        }
        
        function drawPlayers() {
            
            for (var i = 0; i < players.length; i++) {
                ctx.fillStyle = players[i].color;
                ctx.fillRect(players[i].canvasPos.x, players[i].canvasPos.y, players[i].size.width, players[i].size.height);
                ctx.fillStyle = 'black';
            }

        }

        function newGame() {

            makeMap();
            addReservedBlocks();
            generateCrates();
            drawMap();
            drawPlayers();

        }

        function movePlayer(player) {

            posX = player.canvasPos.x;
            posY = player.canvasPos.y;

            if (player.xKeys.right === true && player.xKeys.left === false) {
                player.canvasPos.x = player.canvasPos.x + player.speed;
            }
            else if (player.xKeys.right === false && player.xKeys.left === true) {
                player.canvasPos.x = player.canvasPos.x - player.speed;
            }

            if (player.yKeys.up === true && player.yKeys.down === false) {
                player.canvasPos.y = player.canvasPos.y - player.speed;
            }
            else if (player.yKeys.up === false && player.yKeys.down === true) {
                player.canvasPos.y = player.canvasPos.y + player.speed;
            }

            for (var i = 0; i < map.length; i++) {

                if (map[i].blockType.blockType === blockType.type_wall ||
                    map[i].blockType.blockType === blockType.type_crate) {

                    if (checkCollision(player, map[i])) {
                        player.canvasPos.x = posX;
                        player.canvasPos.y = posY;
                    }

                } else if (map[i].blockType.blockType === blockType.type_empty) {

                    player.mapPos.x = Math.floor(player.canvasPos.x / blockSize);
                    player.mapPos.y = Math.floor(player.canvasPos.y / blockSize);
                    continue;
                    
                }

            }

        }

        function checkCollision(obj1, obj2) {

            if (obj1.canvasPos.x < obj2.canvasPos.x + obj2.size.width &&
                obj1.canvasPos.x + obj1.size.width > obj2.canvasPos.x &&
                obj1.canvasPos.y < obj2.canvasPos.y + obj2.size.height &&
                obj1.size.height + obj1.canvasPos.y > obj2.canvasPos.y) {

                return true;

            }
            else {
                return false;
            }

        }

        function isValidPlaceToLayBomb(x, y) {

            var isValid = true;
            var block = findBlock(x, y);
            
            if (block.hasBomb === true || block.onFire === true) {
            
                isValid = false;

            }

            return isValid;
        }

        function checkIfAnyPlayerTouchesFire() {
            
            var playersWhoTouchFire = [];

            for (var i = 0; i < players.length; i++) {

                for (var j = 0; j < map.length; j++) {
                
                    if (map[j].onFire) {
                    
                        if (checkCollision(players[i], map[j])) {

                            playersWhoTouchFire.push(players[i]);

                        }

                    }

                }

            }

            return playersWhoTouchFire;

        }

        function damagePlayer(player) {

            if (player != null) {

                if (!player.isImmune) {

                    player.health = player.health - 1;

                    if (player.health === 0) {

                        player.die();

                    } else {

                        player.isImmune = true;
                        var oldColor = player.color;
                        player.color = "purple";

                        setTimeout(function () {
                            player.isImmune = false;
                            player.color = oldColor;
                        }, immuneAfterDamageTime);
                        
                        console.log(player.health);

                    }

                } 

            }

        }

        newGame();

        timer.tick = function () {

            var playersWhoTouchFire = checkIfAnyPlayerTouchesFire();
            if (playersWhoTouchFire.length > 0) {

                for (var j = 0; j < playersWhoTouchFire.length; j++) {

                    damagePlayer(playersWhoTouchFire[j]);

                }

            }

            for (var i = 0; i < players.length; i++) {
                movePlayer(players[i]);
            }
            

            ctx.clearRect(0, 0, c.width, c.height);
            drawMap();
            drawPlayers();
        };

        $(document).keydown(function (e) {

            switch (e.keyCode) {

/*ENTER*/           case 13: {
                        if (timer.stopped) {
                            timer.start();
                        } else {
                            timer.stop();
                        }
                    } break;

/*Player 1*/

/*W*/               case 87: {
                        players[0].yKeys.up = true;
                    } break;

/*D*/               case 68: {
                        players[0].xKeys.right = true;
                    } break;

/*S*/               case 83: {
                        players[0].yKeys.down = true;
                    } break;

/*A*/               case 65: {
                        players[0].xKeys.left = true;
                    } break;
/*SPACE*/           case 32: {
                        if (!timer.stopped) {

                            if (players[0].amountOfBombs > 0) {

                                var block = findBlock(players[0].mapPos.x, players[0].mapPos.y);

                                if (isValidPlaceToLayBomb(block.mapPos.x, block.mapPos.y)) {

                                    players[0].amountOfBombs = players[0].amountOfBombs - 1;
                                    players[0].dropBomb(block.mapPos.x, block.mapPos.y, players[0].equippedBomb, players[0]);

                                }

                            } 

                        }
                    } break;

/*Player 2*/

/*UP*/              case 38: {
                        players[1].yKeys.up = true;
                    } break;

/*RIGHT*/           case 39: {
                        players[1].xKeys.right = true;
                    } break;

/*DOWN*/            case 40: {
                        players[1].yKeys.down = true;
                    } break;

/*LEFT*/            case 37: {
                        players[1].xKeys.left = true;
                    } break;
/*FORWARD SLASH*/   case 191: {
                        if (!timer.stopped) {

                            if (players[1].amountOfBombs > 0) {

                                var block = findBlock(players[1].mapPos.x, players[1].mapPos.y);

                                if (isValidPlaceToLayBomb(block.mapPos.x, block.mapPos.y)) {

                                    players[1].amountOfBombs = players[1].amountOfBombs - 1;
                                    players[1].dropBomb(block.mapPos.x, block.mapPos.y, players[1].equippedBomb, players[1]);

                                }

                            }
                                
                        }
                    } break;

            }

        });

        $(document).keyup(function (e) {

            switch (e.keyCode) {

/*Player 1*/

/*W*/           case 87: {
                    players[0].yKeys.up = false;
                } break;

/*D*/           case 68: {
                    players[0].xKeys.right = false;
                } break;

/*S*/           case 83: {
                    players[0].yKeys.down = false;
                } break;

/*A*/           case 65: {
                    players[0].xKeys.left = false;
                } break;

/*Player 2*/

/*UP*/          case 38: {
                    players[1].yKeys.up = false;
                } break;

/*RIGHT*/       case 39: {
                    players[1].xKeys.right = false;
                } break;

/*DOWN*/        case 40: {
                    players[1].yKeys.down = false;
                } break;

/*LEFT*/        case 37: {
                    players[1].xKeys.left = false;
                } break;

            }

        });

        function Block(mapPosX, mapPosY, blockType) {

            this.mapPos = {
                x: mapPosX,
                y: mapPosY
            },
            this.canvasPos = {
                x: Math.floor(mapPosX * blockSize),
                y: Math.floor(mapPosY * blockSize)
            },
            this.size = {
                width: blockSize,
                height: blockSize
            },
            this.blockType = {
                blockType: blockType
            },
            this.walkThrough = false
            

            if (blockType === 0) {

                this.walkThrough = true;
                this.hasBomb = false;
                this.bomb = null;
                this.onFire = false;
                this.letFireDieTimer = new Timer(),
                this.catchOnFire = function (x, y, player) {

                    var thisBlock = findBlock(x, y);

                    if (thisBlock.onFire) {

                        clearTimeout(thisBlock.letFireDieTimer.timeout);
                        thisBlock.letFireDieTimer.start();

                    } else {

                        thisBlock.letFireDieTimer.interval = onFireTime;
                        thisBlock.letFireDieTimer.tick = function () {
                            thisBlock.onFire = false;
                        }
                        thisBlock.onFire = true;
                        thisBlock.letFireDieTimer.start();

                    }

                }

            }

        }

        function Player(x, y, id, color) {

            this.mapPos = {
                x: x,
                y: y
            },
            this.canvasPos = {
                x: Math.floor(x * blockSize),
                y: Math.floor(y * blockSize)
            },
            this.size = {
                width: playerSize,
                height: playerSize
            },
            this.xKeys = {
                right: false,
                left: false
            },
            this.yKeys = {
                up: false,
                down: false
            },
            this.id = id,
            this.color = color,
            this.speed = initialPlayerSpeed,
            this.isDead = false;
            this.isImmune = false;
            this.health = initialPlayerHealth;
            this.amountOfBombs = initialAmountOfBombs,
            this.explosionRange = initialBombRange,
            this.equippedBomb = bombType.type_basic,
            this.dropBomb = function (x, y, bombType, player) {

                var block = findBlock(x, y);
                block.hasBomb = true;
                block.bomb = new Bomb(block.mapPos.x, block.mapPos.y, bombType, player);

                setTimeout(function () {
                    if (block.bomb != null) {
                        block.bomb.explode(x, y, bombType, player);
                    }
                }, explosionTime);
                
            },
            this.die = function () {
                console.log("Player " + this.id + " is dead!");
                this.isDead = true;
            }

        }

        function Bomb(mapPosX, mapPosY, bombType, player) {

            this.player = player,
            this.type = bombType,
            this.mapPos = {
                x: mapPosX,
                y: mapPosY
            },
            this.canvasPos = {
                x: Math.floor(mapPosX * blockSize),
                y: Math.floor(mapPosY * blockSize)
            },
            this.size = {
                width: blockSize,
                height: blockSize
            },
            this.damage = 1,
            //this.Radius = initialBombRadius,
            this.explode = function (x, y, bombType, player) {

                var block = findBlock(x, y);
                block.hasBomb = false;
                block.bomb = null;
                player.amountOfBombs = player.amountOfBombs + 1;
                var explosionRadius = returnSurroundings(x, y, player.explosionRange);
                var blocksThatCatchFire = [];
                blocksThatCatchFire.push(explosionRadius.center);
                
                for (var i = 0; i < explosionRadius.directions.length; i++) {

                    for (var j = 0; j < explosionRadius.directions[i].length; j++) {

                        if (explosionRadius.directions[i][j] != null) {

                            if (explosionRadius.directions[i][j].blockType.blockType === blockType.type_empty) {
                            
                                blocksThatCatchFire.push(explosionRadius.directions[i][j]);

                            } else if (explosionRadius.directions[i][j].blockType.blockType === blockType.type_wall) {
                            
                                break;

                            } else if (explosionRadius.directions[i][j].blockType.blockType === blockType.type_crate) {
                            
                                blocksThatCatchFire.push(explosionRadius.directions[i][j]);
                                break;

                            }

                        }

                    }

                }
                
                for (var i = 0; i < blocksThatCatchFire.length; i++) {
                    
                    switch (blocksThatCatchFire[i].blockType.blockType) {
                        
                        case blockType.type_empty: {

                            if (blocksThatCatchFire[i].hasBomb) {
                                blocksThatCatchFire[i].bomb.explode(blocksThatCatchFire[i].mapPos.x, blocksThatCatchFire[i].mapPos.y, blocksThatCatchFire[i].bomb.type, player);
                            }

                            blocksThatCatchFire[i].catchOnFire(blocksThatCatchFire[i].mapPos.x, blocksThatCatchFire[i].mapPos.y, player);

                        } break;
                        case blockType.type_crate: {

                            blocksThatCatchFire[i].blockType.blockType = blockType.type_empty;
                            blocksThatCatchFire[i].catchOnFire(blocksThatCatchFire[i].mapPos.x, blocksThatCatchFire[i].mapPos.y, player);

                        } break;

                    }

                }

                

            }

        }

        function Timer() {

            this.interval = 0;
            this.stopped = true;
            this.timeout;
            this.timeStarted;
            this.isLoop = false;
            this.tick = function () { }
            this.ticki = function () {

                if (!self.stopped) {

                    self.tick();

                    if (self.isLoop) {
                        self.continue();
                    } else {
                        self.stopped = true;
                    }

                }

            }
            this.start = function () {
                self.timeStarted = Date.now();
                self.stopped = false;
                self.continue();
            }
            this.continue = function () {
                self.timeout = setTimeout(self.ticki, self.interval);
            }
            this.stop = function () {
                self.stopped = true;
            }
            this.add = function (now, time) {
                var newTime = self.interval - (now - self.timeStarted) + time;
                clearTimeout(self.timeout);
                self.timeout = setTimeout(self.ticki, newTime);
            }
            var self = this;

        }

    </script>
</body>
</html>
